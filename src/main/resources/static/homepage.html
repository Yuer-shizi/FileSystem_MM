<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>首页</title>
    <link rel="stylesheet" href="js/assets/css/bootstrap.css">
    <link rel="stylesheet" href="js/bootgrid/jquery.bootgrid.css">
    <link href="js/assets/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <script src="js/util.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/assets/js/bootstrap.min.js"></script>
    <script src="js/bootgrid/jquery.bootgrid.js"></script>
    <script src="js/bootgrid/jquery.bootgrid.fa.js"></script>
    <script src="js/Chart.js"></script>
    <script src="js/chartutils.js"></script>
</head>
<body>
<!--个人信息模态框-->
<div class="modal fade" id="UserForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">修改个人信息：</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" title="id" name="id" id="id" aria-disabled="true"/>
                <div class="form-group row">
                    <label for="nickname" class="col-sm-3 control-label text-right">昵称:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" name="nickname" id="nickname"/>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="username" class="col-sm-3 control-label text-right">登录名:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" name="username" id="username"/>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="phone" class="col-sm-3 control-label text-right">电话:</label>
                    <div class="col-sm-8">
                        <input class="form-control" type="text" name="phone" id="phone"/>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="email" class="col-sm-3 control-label text-right">邮箱:</label>
                    <div class="col-sm-8">
                        <input class="form-control" type="text" name="email" id="email"/>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="sex" class="col-sm-3 control-label text-right">性别:</label>
                    <div class="col-sm-8">
                        <select id="sex" name="sex" class="form-control" data-width="100%">
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="birthday" class="col-sm-3 control-label text-right">生日:</label>
                    <div class="col-sm-8">
                        <input class="form-control" type="text" name="birthday" id="birthday"/>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="address" class="col-sm-3 control-label text-right">地址:</label>
                    <div class="col-sm-8">
                        <input class="form-control" type="text" name="address" id="address"/>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="remark" class="col-sm-3 control-label text-right">备注:</label>
                    <div class="col-sm-8">
                        <input class="form-control" type="text" name="remark" id="remark"/>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button id="submitForm" type="button" class="btn btn-primary">修改</button>
            </div>
        </div>
    </div>
</div>
<!--修改密码模态框-->
<div class="modal fade" id="changePasswordModel" tabindex="-1" role="dialog" aria-labelledby="changeModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="changeModalLabel">修改密码：</h4>
            </div>
            <div class="modal-body">
                <div class="form-group row">
                    <label for="oldPassword" class="col-sm-3 control-label text-right">密码:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" name="oldPassword" id="oldPassword"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="newPassword" class="col-sm-3 control-label text-right">新密码:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" name="newPassword" id="newPassword"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="newPasswordAgain" class="col-sm-3 control-label text-right">确认密码:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" name="newPasswordAgain" id="newPasswordAgain"/>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button id="changePassword" type="button" class="btn btn-primary">修改</button>
            </div>
        </div>
    </div>
</div>

<div class="header">
    <div class="top">
        <div class="wp">
            <div class="y" id="ed">
                <span>
                    <a class="welcome" href="#" id="wel">欢迎 - 用户名</a>
                </span>
                <span style="color:#8c8d8d">|</span>
                <span>
                    <a id="changePawwword" onclick="showModel()">修改密码</a>
                </span>
                <span style="color:#8c8d8d">|</span>
                <span class="usermanament">
                    <a href="usermanagement.html">用户管理</a>
                </span>
                <span class="usermanament" style="color:#8c8d8d">|</span>
                <span>
                    <a href="index.html" onclick="logoff()">退出</a>
                </span>
            </div>

            <script th:inline="javascript">
                /*<![CDATA[*/
                // var usersession =[[${session.user}]];

                var cookie = getCookie("user");
                var btn1 = document.getElementById('ed');

                // 显示用户名
                if (cookie === undefined)
                    btn1.style.display = "none";
                else {
                    var wel = document.getElementById("wel");
                    wel.innerText = "欢迎 - " + cookie.username;
                    if (cookie.username === 'admin')
                        $('.usermanament').show();
                    else
                        $('.usermanament').hide();
                }

                function clearAllCookie() {
                    var keys = document.cookie.match(/[^ =;]+(?==)/g);
                    if (keys) {
                        for (var i = keys.length; i--;)
                            document.cookie = keys[i] + '=0;expires=' + new Date(0).toUTCString()
                    }
                }

                function logoff() {
                    var response = {};
                    $.ajax({
                        async: false,
                        type: 'GET',
                        url: address + "exit",
                        data: String,
                        dataType: 'json',
                        success: function (result) {
                            response = result;
                            clearAllCookie()
                        },
                        error: function (error) {
                            console.log(error);
                            alert('服务器异常');
                        }
                    });
                    console.log(response.content);
                    if (response.status === "0") {
                        clearAllCookie();
                        alert(response.content);
                    }
                }
            </script>
            <script src="js/util.js"></script>
        </div>
    </div>
    <div class="wp">
        <div class="logos">
            <div class="logo z">
                <a href="homepage.html"><img src="img/logo.png" alt="???"></a>
            </div>
            <div class="nav z">
                <div class="wp">
                    <ul>
                        <li style="background-color: #00a0e9;">
                            <a href="homepage.html">首页 <span></span></a>
                        </li>
                        <li>
                            <a href="alldisplay.html">全部 <span></span></a>
                        </li>
                        <li>
                            <a href="folderdisplay.html">文档 <span></span></a>
                        </li>
                        <li>
                            <a href="vediodisplay.html">视频 <span></span></a>
                        </li>
                        <li>
                            <a href="audiodisplay.html">音乐 <span></span></a>
                        </li>
                        <li>
                            <a href="torrentdisplay.html">种子 <span></span></a>
                        </li>
                        <li>
                            <a href="otherdisplay.html">其他 <span></span></a>
                        </li>
                        <li>
                            <button class="buttonEx" id="updateUserMessage">查看个人</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="wp" style="background-color: #363259;z-index: 100">
    <a class="wp" style="color: #e0e0e0">&nbsp;</a>
    <a id="curr_dir" class="wp" style="color: #e0e0e0"></a>
</div>
<br/>
<div class="wp">
    <h2>文件类型分布：</h2>
    <div id="canvas-holder" style="width:80%">
        <canvas id="chart-area"></canvas>
    </div>
</div>
<br/>
<br/>
<div class="wp">
    <h2>近7天文件上传/下载量：</h2>
    <div id="container" style="width: 80%;">
        <canvas id="canvas"></canvas>
    </div>
</div>
<script type="application/javascript">
    var $changePasswordModel = $('#changePasswordModel');
    function showModel() {
        $changePasswordModel.find('input').text('');
        $changePasswordModel.modal('show');
    }
    $('#changePassword').click(function () {
        var newPassword = $('#newPassword').val();
        if (!(/[\w]{6,}/.test(newPassword))) {
            alert('密码只能包含A-Z，a-z，0-9和‘_’且至少6位！');
            return;
        }
        if (newPassword !== $('#newPasswordAgain').val()) {
            alert('两次输入的新密码不同！');
            return;
        }
        var pass = {
            username: getCookie("user").username,
            password: $('#oldPassword').val().trim(),
            newPassword: newPassword
        };
        $.ajax({
            type: 'POST',
            url: address + "change-password",
            dataType: 'json',
            data: pass,
            success: function (result) {
                alert(result.content);
                if (result.status === '0') {
                    $changePasswordModel.modal('hide');
                }
            },
            error: function () {
                alert('服务器异常');
            }
        });
    });

    var $UserForm = $('#UserForm');
    $('#updateUserMessage').click(function () {
        var userinfo = getCookie('user');
        $('#id').val(userinfo.id);
        $('#nickname').val(userinfo.nickname);
        $('#username').val(userinfo.username);
        $('#phone').val(userinfo.phone);
        $('#email').val(userinfo.email);
        $('#sex').val(userinfo.sex);
        $('#birthday').val(userinfo.birthday);
        $('#address').val(userinfo.address);
        $('#remark').val(userinfo.remark);

        $UserForm.modal("show");
    });
    $('#submitForm').click(function () {
        var username = $('#username').val();
        if (username === '') {
            alert("用户名不能为空！");
            return;
        }
        var formData = {
            id: $('#id').val(),
            nickname: $('#nickname').val(),
            username: username,
            phone: $('#phone').val(),
            email: $('#email').val(),
            sex: $('#sex').val(),
            birthday: $('#birthday').val(),
            address: $('#address').val(),
            remark: $('#remark').val()
        };
        $.ajax({
            type: 'POST',
            url: address + "update-user",
            data: formData,
            success: function (result) {
                alert(result.content);
                if (result.status === '0') {
                    $UserForm.modal("hide");
                }
            },
            error: function () {
                alert('服务器异常');
            }
        });
    });

    function initPie() {
        var video = 0;
        var music = 0;
        var text = 0;
        var torrent = 0;
        var other = 0;
        $.ajax({
            async: false,
            type: 'GET',
            url: address + "get-file-type-number",
            dataType: 'json',
            success: function (result) {
                video = result.video;
                music = result.music;
                text = result.text;
                torrent = result.torrent;
                other = result.other;
            },
            error: function () {
                alert('服务器异常');
            }
        });
        var config = {
            type: 'pie',
            data: {
                datasets: [{
                    data: [
                        text,
                        video,
                        music,
                        torrent,
                        other
                    ],
                    backgroundColor: [
                        window.chartColors.purple,
                        window.chartColors.orange,
                        window.chartColors.yellow,
                        window.chartColors.green,
                        window.chartColors.blue
                    ],
                    label: 'Dataset 1'
                }],
                labels: [
                    '文档',
                    '视频',
                    '音乐',
                    '种子',
                    '其他'
                ]
            },
            options: {
                responsive: true
            }
        };

        var ctx = document.getElementById('chart-area').getContext('2d');
        window.myPie = new Chart(ctx, config);
    }

    function initBar() {
        var upload = 0;
        var download = 0;
        $.ajax({
            async: false,
            type: 'GET',
            url: address + "get-last-seven-days-file-number",
            dataType: 'json',
            success: function (result) {
                upload = result.upload;
                download = result.download;
            },
            error: function () {
                alert('服务器异常');
            }
        });

        var color = Chart.helpers.color;
        var barChartData = {
            labels: ['前7天', '前6天', '前5天', '前4天', '前3天', '前2天', '前1天', '今天'],
            datasets: [
                {
                    label: '文件上传量',
                    backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
                    borderColor: window.chartColors.blue,
                    borderWidth: 1,
                    data: upload
                },
                {
                    label: '文件下载量',
                    backgroundColor: color(window.chartColors.green).alpha(0.5).rgbString(),
                    borderColor: window.chartColors.green,
                    borderWidth: 1,
                    data: download
                }
            ]
        };

        var ctx = document.getElementById('canvas').getContext('2d');
        window.myBar = new Chart(ctx, {
            type: 'bar',
            data: barChartData,
            options: {
                responsive: true,
                legend: {
                    position: 'top'
                },
                title: {
                    display: true
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero:true,
                            min: 0,
                            stepSize: 1
                        }
                    }]
                }
            }
        });
    }

    window.onload = function () {
        initPie();
        initBar();
    };
</script>
</body>
</html>