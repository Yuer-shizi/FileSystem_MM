<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>首页</title>
    <link rel="stylesheet" href="js/assets/css/bootstrap.css">
    <link rel="stylesheet" href="js/bootgrid/jquery.bootgrid.css">
    <link href="js/assets/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <script src="js/util.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/assets/js/bootstrap.min.js"></script>
    <script src="js/bootgrid/jquery.bootgrid.js"></script>
    <script src="js/bootgrid/jquery.bootgrid.fa.js"></script>
    <script src="js/Chart.js"></script>
    <script src="js/chartutils.js"></script>
</head>
<body>
<!--修改个人信息模态框-->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">修改个人信息：</h4>
            </div>
            <div class="modal-body">
                <div class="form-group row">
                    <label for="resetPassworduserName1" class="col-sm-3 control-label text-right">昵称:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" name="resetPassworduserName"
                               id="resetPassworduserName1"/>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="resetPassworduserLoginName1" class="col-sm-3 control-label text-right">登录名:</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" name="resetPassworduserLoginName"
                               id="resetPassworduserLoginName1"/>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="resetPassworduserType1" class="col-sm-3 control-label text-right">性别:</label>
                    <div class="col-sm-5">
                        <select id="resetPassworduserType1" class="selectpicker">
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-3 control-label text-right">QQ:</label>
                    <div class="col-sm-8">
                        <input class="form-control" type="text" name="resetPassworduserQQ" id="resetPassworduserQQ1"
                               placeholder=""/>
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-3 control-label text-right">联系电话:</label>
                    <div class="col-sm-8">
                        <input class="form-control" type="text" name="resetPassworduserTel" id="resetPassworduserTel1"
                               placeholder=""/>
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-3 control-label text-right">邮箱:</label>
                    <div class="col-sm-8">
                        <input class="form-control" type="text" name="resetPassworduserEmail"
                               id="resetPassworduserEmail1" placeholder=""/>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button id="updateUserMessageSubmit" type="button" class="btn btn-primary">修改</button>
            </div>
        </div>
    </div>
</div>

<div class="header">
    <div class="top">
        <div class="wp">
            <div class="y" id="ed">
                <span>
                    <a class="welcome" href="#" id="wel">欢迎 - 用户名</a>
                </span>
                <span style="color:#8c8d8d">|</span>
                <span class="usermanament">
                    <a href="usermanagement.html">用户管理</a>
                </span>
                <span class="usermanament" style="color:#8c8d8d">|</span>
                <span>
                    <a href="index.html" onclick="logoff()">退出</a>
                </span>
            </div>

            <script th:inline="javascript">

                /*<![CDATA[*/
                // var usersession =[[${session.user}]];

                var usersession = getCookie("user");
                var cookie = JSON.parse(usersession);
                var btn1 = document.getElementById('ed');

                function addName() {
                    if (cookie === undefined)
                        btn1.style.display = "none";
                    else {
                        var wel = document.getElementById("wel");
                        wel.innerText = "欢迎 - " + cookie.username;
                        if (cookie.username === 'admin')
                            $('.usermanament').show();
                        else
                            $('.usermanament').hide();
                    }
                }

                addName();

                function clearAllCookie() {
                    var keys = document.cookie.match(/[^ =;]+(?==)/g);
                    if (keys) {
                        for (var i = keys.length; i--;)
                            document.cookie = keys[i] + '=0;expires=' + new Date(0).toUTCString()
                    }
                }

                function getUrlPath() {
                    var url = document.location.toString();
                    if (url.indexOf("/") !== -1) {
                        url = url.substring(0, url.lastIndexOf("/"));
                    }
                    var arrUrl = url.split("//");

                    var start = arrUrl[1].indexOf("/");
                    var relUrl = arrUrl[1].substring(start);

                    if (relUrl.indexOf("?") !== -1) {
                        relUrl = relUrl.split("?")[0];
                    }
                    return relUrl.substring(6);
                }

                console.log(getUrlPath());


                function logoff() {
                    var response = {};
                    $.ajax({
                        async: false,
                        type: 'GET',
                        url: address + "exit",
                        data: String,
                        dataType: 'json',
                        success: function (result) {
                            response = result;
                            clearAllCookie()
                        },
                        error: function (error) {
                            console.log(error);
                            alert('服务器异常');
                        }
                    });
                    console.log(response.content);
                    if (response.status === "0") {
                        clearAllCookie();
                        alert(response.content);
                    }
                }
            </script>
            <script src="js/util.js"></script>
        </div>
    </div>
    <div class="wp">
        <div class="logos">
            <div class="logo z">
                <a href="homepage.html"><img src="img/logo.png" alt="???"></a>
            </div>
            <div class="nav z">
                <div class="wp">
                    <ul>
                        <li style="background-color: #00a0e9;">
                            <a href="homepage.html">首页 <span></span></a>
                        </li>
                        <li>
                            <a href="alldisplay.html">全部 <span></span></a>
                        </li>
                        <li>
                            <a href="folderdisplay.html">文档 <span></span></a>
                        </li>
                        <li>
                            <a href="vediodisplay.html">视频 <span></span></a>
                        </li>
                        <li>
                            <a href="audiodisplay.html">音乐 <span></span></a>
                        </li>
                        <li>
                            <a href="torrentdisplay.html">种子 <span></span></a>
                        </li>
                        <li>
                            <a href="otherdisplay.html">其他 <span></span></a>
                        </li>
                        <li>
                            <button class="buttonEx" id="updateUserMessage">查看个人</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="wp" style="background-color: #363259;z-index: 100">
    <a class="wp" style="color: #e0e0e0">&nbsp;</a>
    <a id="curr_dir" class="wp" style="color: #e0e0e0"></a>
</div>
<br/>
<div class="wp">
    <h2>文件类型分布：</h2>
    <div id="canvas-holder" style="width:80%">
        <canvas id="chart-area"></canvas>
    </div>
</div>
<br/>
<br/>
<div class="wp">
    <h2>近7天文件上传/下载量：</h2>
    <div id="container" style="width: 80%;">
        <canvas id="canvas"></canvas>
    </div>
</div>
<script type="application/javascript">

    $('#updateUserMessage').click(function () {
        $('#resetPasswordModal').modal("show");
    });

    function initPie() {
        var video = 0;
        var music = 0;
        var text = 0;
        var torrent = 0;
        var other = 0;
        $.ajax({
            async: false,
            type: 'GET',
            url: address + "get-file-type-number",
            dataType: 'json',
            success: function (result) {
                video = result.video;
                music = result.music;
                text = result.text;
                torrent = result.torrent;
                other = result.other;
            },
            error: function () {
                alert('服务器异常');
            }
        });
        var config = {
            type: 'pie',
            data: {
                datasets: [{
                    data: [
                        text,
                        video,
                        music,
                        torrent,
                        other
                    ],
                    backgroundColor: [
                        window.chartColors.purple,
                        window.chartColors.orange,
                        window.chartColors.yellow,
                        window.chartColors.green,
                        window.chartColors.blue
                    ],
                    label: 'Dataset 1'
                }],
                labels: [
                    '文档',
                    '视频',
                    '音乐',
                    '种子',
                    '其他'
                ]
            },
            options: {
                responsive: true
            }
        };

        var ctx = document.getElementById('chart-area').getContext('2d');
        window.myPie = new Chart(ctx, config);
    }

    function initBar() {
        var upload = 0;
        var download = 0;
        $.ajax({
            async: false,
            type: 'GET',
            url: address + "get-last-seven-days-file-number",
            dataType: 'json',
            success: function (result) {
                upload = result.upload;
                download = result.download;
            },
            error: function () {
                alert('服务器异常');
            }
        });

        var color = Chart.helpers.color;
        var barChartData = {
            labels: ['前7天', '前6天', '前5天', '前4天', '前3天', '前2天', '前1天', '今天'],
            datasets: [
                {
                    label: '文件上传量',
                    backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
                    borderColor: window.chartColors.blue,
                    borderWidth: 1,
                    data: upload
                },
                {
                    label: '文件下载量',
                    backgroundColor: color(window.chartColors.green).alpha(0.5).rgbString(),
                    borderColor: window.chartColors.green,
                    borderWidth: 1,
                    data: download
                }
            ]
        };

        var ctx = document.getElementById('canvas').getContext('2d');
        window.myBar = new Chart(ctx, {
            type: 'bar',
            data: barChartData,
            options: {
                responsive: true,
                legend: {
                    position: 'top'
                },
                title: {
                    display: true
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero:true,
                            min: 0,
                            stepSize: 1
                        }
                    }]
                }
            }
        });
    }

    window.onload = function () {
        initPie();
        initBar();
    };
</script>
</body>
</html>